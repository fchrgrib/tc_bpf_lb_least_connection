apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: conntracker
spec:
  selector:
    matchLabels:
      app: conntracker
  template:
    metadata:
      labels:
        app: conntracker
    spec:
      tolerations:
      - operator: Exists
      serviceAccountName: conntracker
      hostNetwork: true
      hostPID: true
      initContainers:
      - name: kernel-setup
        image: ubuntu:22.04
        command:
        - "/bin/bash"
        - "-c"
        - |
          echo "Checking kernel configuration..."
          echo "Kernel version: $(uname -r)"
          echo "Available headers:"
          ls -la /usr/src/ || echo "No headers found in /usr/src"
          echo "BPF filesystem:"
          mount | grep bpf || echo "No BPF filesystem mounted"
          echo "Init container complete"
        securityContext:
          privileged: true
        volumeMounts:
        - name: lib-modules
          mountPath: /lib/modules
        - name: bpf-fs
          mountPath: /sys/fs/bpf
        - name: kernel-headers
          mountPath: /usr/src
        - name: sys-kernel-debug
          mountPath: /sys/kernel/debug
      containers:
      - name: tracker
        image: fchrgrib/conntracker:latest
        securityContext:
          capabilities:
            add: ["BPF", "NET_ADMIN", "SYS_ADMIN", "SYS_PTRACE", "SYS_RESOURCE"]
          privileged: true
        env:
        - name: USE_INCLUSTER_CONFIG
          value: "true"
        - name: KUBECONFIG
          value: ""
        - name: VERBOSE
          value: "true"
        - name: DEBUG
          value: "true"
        volumeMounts:
        - name: lib-modules
          mountPath: /lib/modules
        - name: bpf-fs
          mountPath: /sys/fs/bpf
        - name: kernel-headers
          mountPath: /usr/src/linux-headers
        - name: sys-kernel-debug
          mountPath: /sys/kernel/debug
        - name: var-run
          mountPath: /var/run
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 20
        ports:
        - containerPort: 8080
          name: metrics
          protocol: TCP
      volumes:
      - name: lib-modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: bpf-fs
        hostPath:
          path: /sys/fs/bpf
          type: Directory
      - name: kernel-headers
        hostPath:
          path: /usr/src
          type: Directory
      - name: sys-kernel-debug
        hostPath:
          path: /sys/kernel/debug
          type: Directory
      - name: var-run
        hostPath:
          path: /var/run
          type: Directory